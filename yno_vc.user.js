// ==UserScript==
// @name         YNO Voice Chat
// @version      0.0.4
// @license      MIT OR Apache-2.0
// @source       https://github.com/AcrylonitrileButadieneStyrene/yno-vc
// @supportURL   https://github.com/AcrylonitrileButadieneStyrene/yno-vc/issues
// @downloadURL  https://raw.githubusercontent.com/AcrylonitrileButadieneStyrene/yno-vc/refs/heads/builds/yno_vc.user.js
// @updateURL    https://raw.githubusercontent.com/AcrylonitrileButadieneStyrene/yno-vc/refs/heads/builds/yno_vc.meta.js
// @match        *://ynoproject.net/*
// @resource     wasm  https://raw.githubusercontent.com/AcrylonitrileButadieneStyrene/yno-vc/refs/heads/builds/yno_vc.wasm?version=0.0.4
// @grant        GM.getResourceUrl
// @grant        GM.getValue
// @grant        GM.setValue
// @grant        unsafeWindow
// ==/UserScript==

(function () {
    'use strict';

    /* This file has been minified to reduce its file size.
     * A readable copy of the code is accessible at the link in the @source tag above.
     */
    ((async function(p){const Re=unsafeWindow.fetch;unsafeWindow.fetch=function(e,t){let n;return e instanceof Request?n=e.url:n=e.toString(),n.includes("relay.pkarr.org")&&(e instanceof Request?e=new Request(e,{cache:"no-store"}):(t||={},t.cache="no-store")),Re.call(this,e,t)};const I=document.createElement("div");I.id="yno_vc_tab",I.className="playerList chatboxTabContent scrollableContainer";const ee=document.createElement("div");ee.style.flex="1",I.appendChild(ee),document.getElementById("players").appendChild(I);const te=document.createElement("style");te.textContent=`
    #yno_vc_tab {
        display: none;
    }

    body:has(#yno_vc_tab_button.active) #playerList {
        display:none;
    }

    body:has(#yno_vc_tab_button.active) #yno_vc_tab {
        display: flex;
        flex-direction: column-reverse;
    }
`,document.head.appendChild(te);const h=document.createElement("div");h.id="yno_vc_tab_button",h.onclick=function(){window.setPlayersTab(this,false);},h.className="playersTab subTab";const W=document.createElement("small");W.className="playersTabLabel subTabLabel infoLabel unselectable",W.textContent="Voice",h.appendChild(W);const ne=document.createElement("div");ne.className="subTabBg",h.appendChild(ne),document.getElementById("playersTabs").appendChild(h);const D=e=>new Promise(t=>setTimeout(t,e)),T=document.createElement("button");T.textContent="Invite all players in this map",T.onclick=async()=>{const e=document.getElementById("chatInput");T.disabled=true,e.style.outline="solid 4px #08f";const t=e.value,n=`/voice:${C}`;for(let _=0;_<n.length;_++)e.value=n.slice(0,_),await D(_==6?200:10);await D(250),unsafeWindow.sendSessionCommand("say",[n]),e.style.outline="",e.value=t,await D(5e3),T.disabled=false;},I.appendChild(T);let m;const w=document.createElement("button");w.textContent="V",w.className="iconButton toggleButton offToggleButton unselectable",w.style.fontSize="22px",w.style.color="red",document.getElementById("leftControls").appendChild(w);let z=false;w.addEventListener("click",()=>{z=!z,z?(w.style.color="green",m||Ce(),m.start(100)):(w.style.color="red",m.stop());});async function Ce(){m=new MediaRecorder(await navigator.mediaDevices.getUserMedia({audio:true}),{mimeType:"audio/webm; codecs=opus",audioBitsPerSecond:6e3}),m.addEventListener("dataavailable",ke);}function Ie(){z&&m?.start();}class v{static __wrap(t){t=t>>>0;const n=Object.create(v.prototype);return n.__wbg_ptr=t,_e.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,_e.unregister(this),t}free(){const t=this.__destroy_into_raw();r.__wbg_connection_free(t,0);}take_public_key(){const t=r.connection_take_public_key(this.__wbg_ptr);let n;return t[0]!==0&&(n=f(t[0],t[1]).slice(),r.__wbindgen_free(t[0],t[1]*1,1)),n}take_receive(){const t=r.connection_take_receive(this.__wbg_ptr);return t===0?void 0:S.__wrap(t)}take_send(){const t=r.connection_take_send(this.__wbg_ptr);return t===0?void 0:F.__wrap(t)}}Symbol.dispose&&(v.prototype[Symbol.dispose]=v.prototype.free);class ${__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,D_.unregister(this),t}free(){const t=this.__destroy_into_raw();r.__wbg_intounderlyingbytesource_free(t,0);}get autoAllocateChunkSize(){return r.intounderlyingbytesource_autoAllocateChunkSize(this.__wbg_ptr)>>>0}cancel(){const t=this.__destroy_into_raw();r.intounderlyingbytesource_cancel(t);}pull(t){return r.intounderlyingbytesource_pull(this.__wbg_ptr,t)}start(t){r.intounderlyingbytesource_start(this.__wbg_ptr,t);}get type(){const t=r.intounderlyingbytesource_type(this.__wbg_ptr);return U_[t]}}Symbol.dispose&&($.prototype[Symbol.dispose]=$.prototype.free);class N{__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,$_.unregister(this),t}free(){const t=this.__destroy_into_raw();r.__wbg_intounderlyingsink_free(t,0);}abort(t){const n=this.__destroy_into_raw();return r.intounderlyingsink_abort(n,t)}close(){const t=this.__destroy_into_raw();return r.intounderlyingsink_close(t)}write(t){return r.intounderlyingsink_write(this.__wbg_ptr,t)}}Symbol.dispose&&(N.prototype[Symbol.dispose]=N.prototype.free);class J{__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,N_.unregister(this),t}free(){const t=this.__destroy_into_raw();r.__wbg_intounderlyingsource_free(t,0);}cancel(){const t=this.__destroy_into_raw();r.intounderlyingsource_cancel(t);}pull(t){return r.intounderlyingsource_pull(this.__wbg_ptr,t)}}Symbol.dispose&&(J.prototype[Symbol.dispose]=J.prototype.free);class B{__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,re.unregister(this),t}free(){const t=this.__destroy_into_raw();r.__wbg_network_free(t,0);}init(){const t=this.__destroy_into_raw();return r.network_init(t)}constructor(t){var n=d(t)?0:l(t,r.__wbindgen_malloc,r.__wbindgen_realloc),_=b;const o=r.network_new(n,_);return this.__wbg_ptr=o>>>0,re.register(this,this.__wbg_ptr,this),this}}Symbol.dispose&&(B.prototype[Symbol.dispose]=B.prototype.free);class k{static __wrap(t){t=t>>>0;const n=Object.create(k.prototype);return n.__wbg_ptr=t,oe.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,oe.unregister(this),t}free(){const t=this.__destroy_into_raw();r.__wbg_networking_free(t,0);}accept(){return r.networking_accept(this.__wbg_ptr)}connect(t){const n=l(t,r.__wbindgen_malloc,r.__wbindgen_realloc),_=b;return r.networking_connect(this.__wbg_ptr,n,_)}get_public_key(){let t,n;try{const _=r.networking_get_public_key(this.__wbg_ptr);return t=_[0],n=_[1],f(_[0],_[1])}finally{r.__wbindgen_free(t,n,1);}}get_secret_key(){let t,n;try{const _=r.networking_get_secret_key(this.__wbg_ptr);return t=_[0],n=_[1],f(_[0],_[1])}finally{r.__wbindgen_free(t,n,1);}}}Symbol.dispose&&(k.prototype[Symbol.dispose]=k.prototype.free);class S{static __wrap(t){t=t>>>0;const n=Object.create(S.prototype);return n.__wbg_ptr=t,ce.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,ce.unregister(this),t}free(){const t=this.__destroy_into_raw();r.__wbg_receiver_free(t,0);}read(){return r.receiver_read(this.__wbg_ptr)}}Symbol.dispose&&(S.prototype[Symbol.dispose]=S.prototype.free);class F{static __wrap(t){t=t>>>0;const n=Object.create(F.prototype);return n.__wbg_ptr=t,ie.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,ie.unregister(this),t}free(){const t=this.__destroy_into_raw();r.__wbg_sender_free(t,0);}send(t){return r.sender_send(this.__wbg_ptr,t)}}Symbol.dispose&&(F.prototype[Symbol.dispose]=F.prototype.free);class L{__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,se.unregister(this),t}free(){const t=this.__destroy_into_raw();r.__wbg_state_free(t,0);}init(){r.state_init(this.__wbg_ptr);}constructor(){const t=r.state_new();return this.__wbg_ptr=t>>>0,se.register(this,this.__wbg_ptr,this),this}on_player_join(t){const n=l(t,r.__wbindgen_malloc,r.__wbindgen_realloc),_=b;return r.state_on_player_join(this.__wbg_ptr,n,_)!==0}on_player_leave(t){const n=l(t,r.__wbindgen_malloc,r.__wbindgen_realloc),_=b;return r.state_on_player_leave(this.__wbg_ptr,n,_)!==0}on_players_cleared(){r.state_on_players_cleared(this.__wbg_ptr);}}Symbol.dispose&&(L.prototype[Symbol.dispose]=L.prototype.free);function Te(){r.main();}function Me(e,t){return Error(f(e,t))}function Ae(e){return Number(e)}function xe(e,t){const n=String(t),_=l(n,r.__wbindgen_malloc,r.__wbindgen_realloc),o=b;a().setInt32(e+4,o,true),a().setInt32(e+0,_,true);}function Oe(e,t){const n=t,_=typeof n=="bigint"?n:void 0;a().setBigInt64(e+8,d(_)?BigInt(0):_,true),a().setInt32(e+0,!d(_),true);}function ze(e){const t=e,n=typeof t=="boolean"?t:void 0;return d(n)?16777215:n?1:0}function Be(e,t){const n=G(t),_=l(n,r.__wbindgen_malloc,r.__wbindgen_realloc),o=b;a().setInt32(e+4,o,true),a().setInt32(e+0,_,true);}function Le(e,t){return e in t}function je(e){return typeof e=="bigint"}function qe(e){return typeof e=="function"}function Ue(e){const t=e;return typeof t=="object"&&t!==null}function Ve(e){return typeof e=="string"}function Pe(e){return e===void 0}function We(e,t){return e===t}function De(e,t){return e==t}function $e(e,t){const n=t,_=typeof n=="number"?n:void 0;a().setFloat64(e+8,d(_)?0:_,true),a().setInt32(e+0,!d(_),true);}function Ne(e,t){const n=t,_=typeof n=="string"?n:void 0;var o=d(_)?0:l(_,r.__wbindgen_malloc,r.__wbindgen_realloc),c=b;a().setInt32(e+4,c,true),a().setInt32(e+0,o,true);}function Je(e,t){throw new Error(f(e,t))}function Ge(e){e._wbg_cb_unref();}function He(e){e.abort();}function Ke(e,t){e.abort(t);}function Xe(){return s(function(e,t,n,_){e.addEventListener(f(t,n),_);},arguments)}function Ye(){return s(function(e,t,n,_,o){e.append(f(t,n),f(_,o));},arguments)}function Qe(){return s(function(e){return e.arrayBuffer()},arguments)}function Ze(e){const t=e.body;return d(t)?0:y(t)}function et(e){return e.buffer}function tt(e){const t=e.byobRequest;return d(t)?0:y(t)}function nt(e){return e.byteLength}function _t(e){return e.byteOffset}function rt(){return s(function(e,t){return e.call(t)},arguments)}function ot(){return s(function(e,t,n){return e.call(t,n)},arguments)}function ct(e){return e.cancel()}function it(e,t){return e.catch(t)}function st(e){return clearTimeout(e)}function at(){return s(function(e,t){e.clearTimeout(t);},arguments)}function ut(){return s(function(e){e.close();},arguments)}function ft(){return s(function(e){e.close();},arguments)}function dt(){return s(function(e){e.close();},arguments)}function bt(e){return e.code}function lt(e){return e.code}function gt(e){return v.__wrap(e)}function wt(e){return e.crypto}function yt(e){return e.data}function pt(e){console.debug(e);}function mt(e){return e.done}function ht(){return s(function(e,t){e.enqueue(t);},arguments)}function vt(e){return Object.entries(e)}function kt(e,t){let n,_;try{n=e,_=t,console.error(f(e,t));}finally{r.__wbindgen_free(n,_,1);}}function St(e){console.error(e);}function Ft(e){return fetch(e)}function Et(e,t){return e.fetch(t)}function Rt(){return s(function(e,t){globalThis.crypto.getRandomValues(E(e,t));},arguments)}function Ct(){return s(function(e,t){e.getRandomValues(t);},arguments)}function It(){return s(function(e){return e.getReader()},arguments)}function Tt(e,t){return e[t>>>0]}function Mt(){return s(function(e,t){return Reflect.get(e,t)},arguments)}function At(e){const t=e.done;return d(t)?16777215:t?1:0}function xt(e){return e.value}function Ot(e,t){return e[t]}function zt(){return s(function(e,t){return Reflect.has(e,t)},arguments)}function Bt(e){return e.headers}function Lt(e){console.info(e);}function jt(e){let t;try{t=e instanceof ArrayBuffer;}catch{t=false;}return t}function qt(e){let t;try{t=e instanceof Blob;}catch{t=false;}return t}function Ut(e){let t;try{t=e instanceof Map;}catch{t=false;}return t}function Vt(e){let t;try{t=e instanceof Response;}catch{t=false;}return t}function Pt(e){let t;try{t=e instanceof Uint8Array;}catch{t=false;}return t}function Wt(e){return Array.isArray(e)}function Dt(e){return Number.isSafeInteger(e)}function $t(){return Symbol.iterator}function Nt(e){return e.length}function Jt(e){return e.length}function Gt(e){console.log(e);}function Ht(e,t){const n=t.message,_=l(n,r.__wbindgen_malloc,r.__wbindgen_realloc),o=b;a().setInt32(e+4,o,true),a().setInt32(e+0,_,true);}function Kt(e){return e.msCrypto}function Xt(e){return k.__wrap(e)}function Yt(){return s(function(e,t){return new WebSocket(f(e,t))},arguments)}function Qt(){return new Object}function Zt(){return new Array}function en(){return s(function(){return new Headers},arguments)}function tn(e,t){return new Error(f(e,t))}function nn(){return new Error}function _n(e,t){try{var n={a:e,b:t},_=(c,i)=>{const u=n.a;n.a=0;try{return j_(u,n.b,c,i)}finally{n.a=u;}};return new Promise(_)}finally{n.a=n.b=0;}}function rn(){return s(function(){return new AbortController},arguments)}function on(){return new Map}function cn(e){return new Uint8Array(e)}function sn(e,t){return new Uint8Array(E(e,t))}function an(e,t){return new Function(f(e,t))}function un(e,t,n){return new Uint8Array(e,t>>>0,n>>>0)}function fn(e){return new Uint8Array(e>>>0)}function dn(){return s(function(e,t,n){return new Request(f(e,t),n)},arguments)}function bn(){return s(function(e,t,n){return new WebSocket(f(e,t),n)},arguments)}function ln(){return s(function(e){return e.next()},arguments)}function gn(e){return e.next}function wn(e){return e.node}function yn(e){return e.now()}function pn(){return Date.now()}function mn(e){return e.performance}function hn(e){return e.process}function vn(e,t,n){Uint8Array.prototype.set.call(E(e,t),n);}function kn(e,t){return e.push(t)}function Sn(e){return e.queueMicrotask}function Fn(e){queueMicrotask(e);}function En(){return s(function(e,t){e.randomFillSync(t);},arguments)}function Rn(e){return e.read()}function Cn(e){return e.readyState}function In(e,t){const n=t.reason,_=l(n,r.__wbindgen_malloc,r.__wbindgen_realloc),o=b;a().setInt32(e+4,o,true),a().setInt32(e+0,_,true);}function Tn(e){e.releaseLock();}function Mn(){return s(function(e,t,n,_){e.removeEventListener(f(t,n),_);},arguments)}function An(){return s(function(){return module.require},arguments)}function xn(e){return Promise.resolve(e)}function On(){return s(function(e,t){e.respond(t>>>0);},arguments)}function zn(){return s(function(e,t,n){e.send(E(t,n));},arguments)}function Bn(){return s(function(e,t,n){e.send(f(t,n));},arguments)}function Ln(){return s(function(e,t,n){return e.setTimeout(t,n)},arguments)}function jn(e,t){return setTimeout(e,t)}function qn(e,t,n){return e.set(t,n)}function Un(e,t,n){e[t]=n;}function Vn(e,t){e.binaryType=q_[t];}function Pn(e,t){e.body=t;}function Wn(e,t){e.cache=V_[t];}function Dn(e,t,n){e.set(E(t,n));}function $n(e,t){e.credentials=P_[t];}function Nn(e,t,n){e[t>>>0]=n;}function Jn(e,t){e.handleEvent=t;}function Gn(e,t){e.headers=t;}function Hn(e,t,n){e.method=f(t,n);}function Kn(e,t){e.mode=W_[t];}function Xn(e,t){e.onclose=t;}function Yn(e,t){e.onerror=t;}function Qn(e,t){e.onmessage=t;}function Zn(e,t){e.onopen=t;}function e_(e,t){e.signal=t;}function t_(e){return e.signal}function n_(e,t){const n=t.stack,_=l(n,r.__wbindgen_malloc,r.__wbindgen_realloc),o=b;a().setInt32(e+4,o,true),a().setInt32(e+0,_,true);}function __(){const e=typeof global>"u"?null:global;return d(e)?0:y(e)}function r_(){const e=typeof globalThis>"u"?null:globalThis;return d(e)?0:y(e)}function o_(){const e=typeof self>"u"?null:self;return d(e)?0:y(e)}function c_(){const e=typeof window>"u"?null:window;return d(e)?0:y(e)}function i_(e){return e.status}function s_(){return s(function(e){return JSON.stringify(e)},arguments)}function a_(e,t,n){return e.subarray(t>>>0,n>>>0)}function u_(e,t,n){return e.then(t,n)}function f_(e,t){return e.then(t)}function d_(e,t){const n=t.url,_=l(n,r.__wbindgen_malloc,r.__wbindgen_realloc),o=b;a().setInt32(e+4,o,true),a().setInt32(e+0,_,true);}function b_(e,t){const n=t.url,_=l(n,r.__wbindgen_malloc,r.__wbindgen_realloc),o=b;a().setInt32(e+4,o,true),a().setInt32(e+0,_,true);}function l_(e){return e.value}function g_(e){return e.versions}function w_(e){const t=e.view;return d(t)?0:y(t)}function y_(e){console.warn(e);}function p_(e){return e.wasClean}function m_(e,t){return A(e,t,r.wasm_bindgen_38f00d9bf905c2cd___closure__destroy___dyn_core_458784977a8e0d71___ops__function__FnMut__web_sys_50deccd95922e012___features__gen_CloseEvent__CloseEvent____Output_______,z_)}function h_(e,t){return J_(e,t,r.wasm_bindgen_38f00d9bf905c2cd___closure__destroy___dyn_core_458784977a8e0d71___ops__function__Fn_____Output_______,A_)}function v_(e,t){return A(e,t,r.wasm_bindgen_38f00d9bf905c2cd___closure__destroy___dyn_core_458784977a8e0d71___ops__function__FnMut__web_sys_50deccd95922e012___features__gen_MessageEvent__MessageEvent____Output_______,B_)}function k_(e,t){return A(e,t,r.wasm_bindgen_38f00d9bf905c2cd___closure__destroy___dyn_core_458784977a8e0d71___ops__function__FnMut_____Output_______,x_)}function S_(e,t){return A(e,t,r.wasm_bindgen_38f00d9bf905c2cd___closure__destroy___dyn_core_458784977a8e0d71___ops__function__FnMut_____Output________1_,O_)}function F_(e,t){return A(e,t,r.wasm_bindgen_38f00d9bf905c2cd___closure__destroy___dyn_core_458784977a8e0d71___ops__function__FnMut__wasm_bindgen_38f00d9bf905c2cd___JsValue____Output_______,L_)}function E_(e){return e}function R_(e){return e}function C_(e,t){return E(e,t)}function I_(e,t){return f(e,t)}function T_(e){return BigInt.asUintN(64,e)}function M_(){const e=r.__wbindgen_externrefs,t=e.grow(4);e.set(0,void 0),e.set(t+0,void 0),e.set(t+1,null),e.set(t+2,true),e.set(t+3,false);}function A_(e,t){r.wasm_bindgen_38f00d9bf905c2cd___convert__closures_____invoke______(e,t);}function x_(e,t){r.wasm_bindgen_38f00d9bf905c2cd___convert__closures_____invoke_______1_(e,t);}function O_(e,t){r.wasm_bindgen_38f00d9bf905c2cd___convert__closures_____invoke_______2_(e,t);}function z_(e,t,n){r.wasm_bindgen_38f00d9bf905c2cd___convert__closures_____invoke___web_sys_50deccd95922e012___features__gen_CloseEvent__CloseEvent_____(e,t,n);}function B_(e,t,n){r.wasm_bindgen_38f00d9bf905c2cd___convert__closures_____invoke___web_sys_50deccd95922e012___features__gen_MessageEvent__MessageEvent_____(e,t,n);}function L_(e,t,n){r.wasm_bindgen_38f00d9bf905c2cd___convert__closures_____invoke___wasm_bindgen_38f00d9bf905c2cd___JsValue_____(e,t,n);}function j_(e,t,n,_){r.wasm_bindgen_38f00d9bf905c2cd___convert__closures_____invoke___wasm_bindgen_38f00d9bf905c2cd___JsValue__wasm_bindgen_38f00d9bf905c2cd___JsValue_____(e,t,n,_);}const q_=["blob","arraybuffer"],U_=["bytes"],V_=["default","no-store","reload","no-cache","force-cache","only-if-cached"],P_=["omit","same-origin","include"],W_=["same-origin","no-cors","cors","navigate"],_e=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>r.__wbg_connection_free(e>>>0,1)),D_=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>r.__wbg_intounderlyingbytesource_free(e>>>0,1)),$_=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>r.__wbg_intounderlyingsink_free(e>>>0,1)),N_=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>r.__wbg_intounderlyingsource_free(e>>>0,1)),re=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>r.__wbg_network_free(e>>>0,1)),oe=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>r.__wbg_networking_free(e>>>0,1)),ce=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>r.__wbg_receiver_free(e>>>0,1)),ie=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>r.__wbg_sender_free(e>>>0,1)),se=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>r.__wbg_state_free(e>>>0,1));function y(e){const t=r.__externref_table_alloc();return r.__wbindgen_externrefs.set(t,e),t}const j=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>e.dtor(e.a,e.b));function G(e){const t=typeof e;if(t=="number"||t=="boolean"||e==null)return `${e}`;if(t=="string")return `"${e}"`;if(t=="symbol"){const o=e.description;return o==null?"Symbol":`Symbol(${o})`}if(t=="function"){const o=e.name;return typeof o=="string"&&o.length>0?`Function(${o})`:"Function"}if(Array.isArray(e)){const o=e.length;let c="[";o>0&&(c+=G(e[0]));for(let i=1;i<o;i++)c+=", "+G(e[i]);return c+="]",c}const n=/\[object ([^\]]+)\]/.exec(toString.call(e));let _;if(n&&n.length>1)_=n[1];else return toString.call(e);if(_=="Object")try{return "Object("+JSON.stringify(e)+")"}catch{return "Object"}return e instanceof Error?`${e.name}: ${e.message}
${e.stack}`:_}function E(e,t){return e=e>>>0,M().subarray(e/1,e/1+t)}let R=null;function a(){return (R===null||R.buffer.detached===true||R.buffer.detached===void 0&&R.buffer!==r.memory.buffer)&&(R=new DataView(r.memory.buffer)),R}function f(e,t){return e=e>>>0,H_(e,t)}let q=null;function M(){return (q===null||q.byteLength===0)&&(q=new Uint8Array(r.memory.buffer)),q}function s(e,t){try{return e.apply(this,t)}catch(n){const _=y(n);r.__wbindgen_exn_store(_);}}function d(e){return e==null}function J_(e,t,n,_){const o={a:e,b:t,cnt:1,dtor:n},c=(...i)=>{o.cnt++;try{return _(o.a,o.b,...i)}finally{c._wbg_cb_unref();}};return c._wbg_cb_unref=()=>{--o.cnt===0&&(o.dtor(o.a,o.b),o.a=0,j.unregister(o));},j.register(c,o,o),c}function A(e,t,n,_){const o={a:e,b:t,cnt:1,dtor:n},c=(...i)=>{o.cnt++;const u=o.a;o.a=0;try{return _(u,o.b,...i)}finally{o.a=u,c._wbg_cb_unref();}};return c._wbg_cb_unref=()=>{--o.cnt===0&&(o.dtor(o.a,o.b),o.a=0,j.unregister(o));},j.register(c,o,o),c}function l(e,t,n){if(n===void 0){const u=x.encode(e),O=t(u.length,1)>>>0;return M().subarray(O,O+u.length).set(u),b=u.length,O}let _=e.length,o=t(_,1)>>>0;const c=M();let i=0;for(;i<_;i++){const u=e.charCodeAt(i);if(u>127)break;c[o+i]=u;}if(i!==_){i!==0&&(e=e.slice(i)),o=n(o,_,_=i+e.length*3,1)>>>0;const u=M().subarray(o+i,o+_),O=x.encodeInto(e,u);i+=O.written,o=n(o,_,i,1)>>>0;}return b=i,o}let U=new TextDecoder("utf-8",{ignoreBOM:true,fatal:true});U.decode();const G_=2146435072;let H=0;function H_(e,t){return H+=t,H>=G_&&(U=new TextDecoder("utf-8",{ignoreBOM:true,fatal:true}),U.decode(),H=t),U.decode(M().subarray(e,e+t))}const x=new TextEncoder;"encodeInto"in x||(x.encodeInto=function(e,t){const n=x.encode(e);return t.set(n),{read:e.length,written:n.length}});let b=0,r;function ae(e){r=e;}const K_=Object.freeze(Object.defineProperty({__proto__:null,Connection:v,IntoUnderlyingByteSource:$,IntoUnderlyingSink:N,IntoUnderlyingSource:J,Network:B,Networking:k,Receiver:S,Sender:F,State:L,__wbg_Error_8c4e43fe74559d73:Me,__wbg_Number_04624de7d0e8332d:Ae,__wbg_String_8f0eb39a4a4c2f66:xe,__wbg___wbindgen_bigint_get_as_i64_8fcf4ce7f1ca72a2:Oe,__wbg___wbindgen_boolean_get_bbbb1c18aa2f5e25:ze,__wbg___wbindgen_debug_string_0bc8482c6e3508ae:Be,__wbg___wbindgen_in_47fa6863be6f2f25:Le,__wbg___wbindgen_is_bigint_31b12575b56f32fc:je,__wbg___wbindgen_is_function_0095a73b8b156f76:qe,__wbg___wbindgen_is_object_5ae8e5880f2c1fbd:Ue,__wbg___wbindgen_is_string_cd444516edc5b180:Ve,__wbg___wbindgen_is_undefined_9e4d92534c42d778:Pe,__wbg___wbindgen_jsval_eq_11888390b0186270:We,__wbg___wbindgen_jsval_loose_eq_9dd77d8cd6671811:De,__wbg___wbindgen_number_get_8ff4255516ccad3e:$e,__wbg___wbindgen_string_get_72fb696202c56729:Ne,__wbg___wbindgen_throw_be289d5034ed271b:Je,__wbg__wbg_cb_unref_d9b87ff7982e3b21:Ge,__wbg_abort_2f0584e03e8e3950:He,__wbg_abort_d549b92d3c665de1:Ke,__wbg_addEventListener_14e74488d3142fa7:Xe,__wbg_append_a992ccc37aa62dc4:Ye,__wbg_arrayBuffer_bb54076166006c39:Qe,__wbg_body_3a0b4437dadea6bf:Ze,__wbg_buffer_26d0910f3a5bc899:et,__wbg_byobRequest_80e594e6da4e1af7:tt,__wbg_byteLength_3417f266f4bf562a:nt,__wbg_byteOffset_f88547ca47c86358:_t,__wbg_call_389efe28435a9388:rt,__wbg_call_4708e0c13bdc8e95:ot,__wbg_cancel_2c0a0a251ff6b2b7:ct,__wbg_catch_c1f8c7623b458214:it,__wbg_clearTimeout_42d9ccd50822fd3a:st,__wbg_clearTimeout_5e42188b495715bb:at,__wbg_close_06dfa0a815b9d71f:ut,__wbg_close_1d08eaf57ed325c0:ft,__wbg_close_a79afee31de55b36:dt,__wbg_code_35e4ec59fbc7d427:bt,__wbg_code_a552f1e91eda69b7:lt,__wbg_connection_new:gt,__wbg_crypto_86f2631e91b51511:wt,__wbg_data_5330da50312d0bc1:yt,__wbg_debug_a4099fa12db6cd61:pt,__wbg_done_57b39ecd9addfe81:mt,__wbg_enqueue_2c63f2044f257c3e:ht,__wbg_entries_58c7934c745daac7:vt,__wbg_error_7534b8e9a36f1ab4:kt,__wbg_error_9a7fe3f932034cde:St,__wbg_fetch_6bbc32f991730587:Ft,__wbg_fetch_afb6a4b6cacf876d:Et,__wbg_getRandomValues_1c61fac11405ffdc:Rt,__wbg_getRandomValues_b3f15fcbfabb0f8b:Ct,__wbg_getReader_48e00749fe3f6089:It,__wbg_get_9b94d73e6221f75c:Tt,__wbg_get_b3ed3ad4be2bc8ac:Mt,__wbg_get_done_1ad1c16537f444c6:At,__wbg_get_value_6b77a1b7b90c9200:xt,__wbg_get_with_ref_key_1dc361bd10053bfe:Ot,__wbg_has_d4e53238966c12b6:zt,__wbg_headers_59a2938db9f80985:Bt,__wbg_info_148d043840582012:Lt,__wbg_instanceof_ArrayBuffer_c367199e2fa2aa04:jt,__wbg_instanceof_Blob_ce92a9ddd729a84a:qt,__wbg_instanceof_Map_53af74335dec57f4:Ut,__wbg_instanceof_Response_ee1d54d79ae41977:Vt,__wbg_instanceof_Uint8Array_9b9075935c74707c:Pt,__wbg_isArray_d314bb98fcf08331:Wt,__wbg_isSafeInteger_bfbc7332a9768d2a:Dt,__wbg_iterator_6ff6560ca1568e55:$t,__wbg_length_32ed9a279acd054c:Nt,__wbg_length_35a7bace40f36eac:Jt,__wbg_log_6b5ca2e6124b2808:Gt,__wbg_message_0b2b0298a231b0d4:Ht,__wbg_msCrypto_d562bbe83e0d4b91:Kt,__wbg_networking_new:Xt,__wbg_new_057993d5b5e07835:Yt,__wbg_new_361308b2356cecd0:Qt,__wbg_new_3eb36ae241fe6f44:Zt,__wbg_new_64284bd487f9d239:en,__wbg_new_72b49615380db768:tn,__wbg_new_8a6f238a6ece86ea:nn,__wbg_new_b5d9e2fb389fef91:_n,__wbg_new_b949e7f56150a5d1:rn,__wbg_new_dca287b076112a51:on,__wbg_new_dd2b680c8bf6ae29:cn,__wbg_new_from_slice_a3d2629dc1826784:sn,__wbg_new_no_args_1c7c842f08d00ebb:an,__wbg_new_with_byte_offset_and_length_aa261d9c9da49eb1:un,__wbg_new_with_length_a2c39cbe88fd8ff1:fn,__wbg_new_with_str_and_init_a61cbc6bdef21614:dn,__wbg_new_with_str_sequence_b67b3919b8b11238:bn,__wbg_next_3482f54c49e8af19:ln,__wbg_next_418f80d8f5303233:gn,__wbg_node_e1f24f89a7336c2e:wn,__wbg_now_2c95c9de01293173:yn,__wbg_now_a3af9a2f4bbaa4d1:pn,__wbg_performance_7a3ffd0b17f663ad:mn,__wbg_process_3975fd6c72f520aa:hn,__wbg_prototypesetcall_bdcdcc5842e4d77d:vn,__wbg_push_8ffdcb2063340ba5:kn,__wbg_queueMicrotask_0aa0a927f78f5d98:Sn,__wbg_queueMicrotask_5bb536982f78a56f:Fn,__wbg_randomFillSync_f8c153b79f285817:En,__wbg_read_68fd377df67e19b0:Rn,__wbg_readyState_1bb73ec7b8a54656:Cn,__wbg_reason_35fce8e55dd90f31:In,__wbg_releaseLock_aa5846c2494b3032:Tn,__wbg_removeEventListener_34a7e78acf851dd7:Mn,__wbg_require_b74f47fc2d022fd6:An,__wbg_resolve_002c4b7d9d8f6b64:xn,__wbg_respond_bf6ab10399ca8722:On,__wbg_send_542f95dea2df7994:zn,__wbg_send_bc0336a1b5ce4fb7:Bn,__wbg_setTimeout_2b111259203a2623:Ln,__wbg_setTimeout_4ec014681668a581:jn,__wbg_set_1eb0999cf5d27fc8:qn,__wbg_set_3f1d0b984ed272ed:Un,__wbg_set_binaryType_5bbf62e9f705dc1a:Vn,__wbg_set_body_9a7e00afe3cfe244:Pn,__wbg_set_cache_315a3ed773a41543:Wn,__wbg_set_cc56eefd2dd91957:Dn,__wbg_set_credentials_c4a58d2e05ef24fb:$n,__wbg_set_f43e577aea94465b:Nn,__wbg_set_handle_event_ea7145e4fd7c71f1:Jn,__wbg_set_headers_cfc5f4b2c1f20549:Gn,__wbg_set_method_c3e20375f5ae7fac:Hn,__wbg_set_mode_b13642c312648202:Kn,__wbg_set_onclose_d382f3e2c2b850eb:Xn,__wbg_set_onerror_377f18bf4569bf85:Yn,__wbg_set_onmessage_2114aa5f4f53051e:Qn,__wbg_set_onopen_b7b52d519d6c0f11:Zn,__wbg_set_signal_f2d3f8599248896d:e_,__wbg_set_wasm:ae,__wbg_signal_d1285ecab4ebc5ad:t_,__wbg_stack_0ed75d68575b0f3c:n_,__wbg_static_accessor_GLOBAL_12837167ad935116:__,__wbg_static_accessor_GLOBAL_THIS_e628e89ab3b1c95f:r_,__wbg_static_accessor_SELF_a621d3dfbb60d0ce:o_,__wbg_static_accessor_WINDOW_f8727f0cf888e0bd:c_,__wbg_status_89d7e803db911ee7:i_,__wbg_stringify_8d1cc6ff383e8bae:s_,__wbg_subarray_a96e1fef17ed23cb:a_,__wbg_then_0d9fe2c7b1857d32:u_,__wbg_then_b9e7b3b5f1a9e1b5:f_,__wbg_url_c484c26b1fbf5126:d_,__wbg_url_cb4d34db86c24df9:b_,__wbg_value_0546255b415e96c1:l_,__wbg_versions_4e31226f5e8dc909:g_,__wbg_view_6c32e7184b8606ad:w_,__wbg_warn_f7ae1b2e66ccb930:y_,__wbg_wasClean_a9c77a7100d8534f:p_,__wbindgen_cast_0000000000000001:m_,__wbindgen_cast_0000000000000002:h_,__wbindgen_cast_0000000000000003:v_,__wbindgen_cast_0000000000000004:k_,__wbindgen_cast_0000000000000005:S_,__wbindgen_cast_0000000000000006:F_,__wbindgen_cast_0000000000000007:E_,__wbindgen_cast_0000000000000008:R_,__wbindgen_cast_0000000000000009:C_,__wbindgen_cast_000000000000000a:I_,__wbindgen_cast_000000000000000b:T_,__wbindgen_init_externref_table:M_,main:Te},Symbol.toStringTag,{value:"Module"})),X_=await GM.getResourceUrl("wasm"),Y_=await(await fetch(X_)).arrayBuffer(),Q_=await WebAssembly.compile(Y_),ue=(await WebAssembly.instantiate(Q_,{"./yno_vc_bg.js":K_})).exports;ae(ue),ue.__wbindgen_start();const Z_={new(e){const t={element:document.createElement("audio"),buffer:void 0,media:void 0,queue:[]};return t.media=new MediaSource,t.element.src=URL.createObjectURL(t.media),t.media.onsourceopen=()=>{t.buffer=t.media.addSourceBuffer("audio/webm; codecs=opus"),t.buffer.mode="sequence",t.buffer.addEventListener("updateend",fe.bind(null,t));},t.element.play().catch(()=>{}),{public_key:e.take_public_key(),send:e.take_send(),receive:e.take_receive(),audio:t,shouldClose:false}}};function fe(e){try{if(!e.queue.length||e.buffer.updating)return;for(;e.queue.length>10;)e.queue.shift();const t=e.queue.shift();t&&e.buffer?.appendBuffer(t);}catch(t){console.log("An error occured while playing audio:",t,e.buffer.updating,e.media.sourceBuffers,e.element.error);}}const V=await GM.getValue("keys")||{},de=new Set,be=new Set;for(const e of Object.values(V))be.has(e)?de.add(e):be.add(e);const K={},X={};for(const[e,t]of Object.entries(V))de.has(t)||(K[e]=t,X[t]=e);function le(e){return K[e]}function er(e){return X[e]}function tr(e,t){V[e]=t,K[e]=t,X[t]=e,GM.setValue("keys",V);}function nr(e){Y("addOrUpdatePlayerListEntry",t=>t?.uuid&&e.on_player_join(t.uuid)&&Se(t.uuid)),Y("removePlayerListEntry",t=>t&&e.on_player_leave(t)&&Fe(t)),Y("clearPlayerList",()=>(e.on_players_cleared(),Ee()));}function Y(e,t){const n=unsafeWindow[e];unsafeWindow[e]=function(_,o){return (!_||_.id=="playerList")&&t(o),n.apply(this,arguments)};}let ge={};function _r(){ge=unsafeWindow.eval("globalPlayerData");}function we(e){return ge[e]}const ye=await GM.getValue("secret_key"),P=await new B(ye).init();ye==null&&GM.setValue("secret_key",P.get_secret_key());const C=P.get_public_key(),pe=new L,g=new Set,rr=setInterval(()=>{unsafeWindow.chatboxAddMessage&&(clearInterval(rr),pe.init(),_r(),or(),nr(pe));},1e3);function or(){const e=unsafeWindow.chatboxAddMessage;unsafeWindow.chatboxAddMessage=function(t,n,_){const o=t.split(":");do{if(o[0]!="/voice")break;const c=o[1];if(c==C)break;tr(_,c);const i=[...g].find(u=>u.public_key==c);i?i.uuid=_:me(_,c);}while(false);return e.apply(this,arguments)};}let Q=new Set;async function me(e,t){t!=C&&(Q.has(t)||[...g].find(n=>n.uuid==e||n.public_key==t)||(console.log(`Connecting to ${t}`),Q.add(t),P.connect(t).then(n=>{console.log(`Connected to ${t}`),he(n).uuid=e;}).catch(n=>{console.log(`Failed to connect to ${t}: ${n}`);}).then(()=>{Q.delete(t);})));}(async function(){for(;;)await P.accept().then(he).catch(e=>{console.log("Failed accepting connection: "+e);});})();function he(e){const t=Z_.new(e);return cr(t),m?.stop(),g.add(t),Ie(),t}function Z(e,t){e.shouldClose=true,g.delete(e),t&&(t=t.replaceAll("%player%",we(e?.uuid)?.name||"an unidentified player"),console.log(t));}async function ve(e,t){try{await e.send.send(t);}catch(n){Z(e,`Voice disconnected %player% due to send error ${n}`);}}async function cr(e){try{for(;!e.shouldClose;){const t=await e.receive.read(),n=t.get("type"),_=t.get("data");({Hello(){e.uuid=le(e.public_key),e.uuid||ve(e,{type:"Identify"});},Identify(){const o=er(e.public_key);if(!o)return Z(e);const c=unsafeWindow.showToastMessage(`${we(o).name} requires identification`),i=unsafeWindow.getSvgIcon("join",!0);i.className+=" iconButton",i.onclick=()=>{unsafeWindow.sendSessionCommand("say",["/voice:"+C]),c.remove();},c.insertBefore(i,c.querySelector(".closeToast"));},VoiceData(o){const c=new Uint8Array(o),{queue:i,element:u}=e.audio;i.push(c),u.paused&&u.play().catch(()=>{}),fe(e.audio);}}[n]||(()=>{throw `unexpected ${n} packet`}))(_);}}catch(t){Z(e,`Voice disconnected %player% due to receive error ${t}`);}}async function ke(e){if(!e.data.size)return;const t={type:"VoiceData",data:Array.from(await e.data.bytes())},n=[...g].map(_=>ve(_,t));for(const _ of n)await _;}function Se(e){const t=[...g].find(n=>n.uuid==e.uuid);if(t)t.expiration&&(clearTimeout(t.expiration),t.expiration=void 0);else {const n=le(e.uuid);if(!n||n>=C)return;me(e.uuid,n);}}function Fe(e){const t=[...g].find(n=>n.uuid==e);t&&(t.expiration=setTimeout(()=>{g.delete(t);},3e4));}function Ee(){for(const e of [...g])e.expiration=setTimeout(()=>{g.delete(e);},3e4);}return p.onMicrophoneData=ke,p.onPlayerJoin=Se,p.onPlayerLeave=Fe,p.onPlayersCleared=Ee,p.public_key=C,Object.defineProperty(p,Symbol.toStringTag,{value:"Module"}),p}))({});

})();